name: flare-github-actions -> DockerHub

on: 
  workflow_dispatch:
    inputs:
      # BASE_IMAGE is the full user/name:tag of the base image to build from 
      # For FLARE, use rocker/geospatial which includes all geospatial dependencies
      BASE_IMAGE:
        description: 'user/name:tag of the base image e.g. rocker/geospatial:4.3.1'
        required: true
        default: 'rocker/geospatial:4.3.1'
      # TARGET_NAME is the name of the FLARE-FaaSr image to build
      TARGET_NAME:
        description: 'name of the FLARE-FaaSr image to build'
        required: true
        default: 'flare-faasr'
      # FAASR_VERSION is the FaaSr version tag to be used
      FAASR_VERSION:
        description: 'FaaSr version'
        required: true
        default: '1.2.0'
      # FAASR_INSTALL_REPO is the GitHub repo to install FaaSr from
      FAASR_INSTALL_REPO:
        description: 'GitHub repo to install FaaSr from'
        required: true
        default: 'faasr/FaaSr-package'

permissions: write-all

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build FLARE GitHub Actions image
        run: |
          cd faas_specific
          docker build -f flare-github-actions.Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.inputs.TARGET_NAME }}:${{ github.event.inputs.FAASR_VERSION }} \
            --build-arg BASE_IMAGE=${{ github.event.inputs.BASE_IMAGE }} \
            --build-arg FAASR_VERSION=${{ github.event.inputs.FAASR_VERSION }} \
            --build-arg FAASR_INSTALL_REPO=${{ github.event.inputs.FAASR_INSTALL_REPO }} \
            .
            
      - name: Push FLARE GitHub Actions image to DockerHub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.inputs.TARGET_NAME }}:${{ github.event.inputs.FAASR_VERSION }}
